(function(e){function t(t){for(var a,o,s=t[0],l=t[1],u=t[2],f=0,p=[];f<s.length;f++)o=s[f],Object.prototype.hasOwnProperty.call(n,o)&&n[o]&&p.push(n[o][0]),n[o]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a]);c&&c(t);while(p.length)p.shift()();return i.push.apply(i,u||[]),r()}function r(){for(var e,t=0;t<i.length;t++){for(var r=i[t],a=!0,s=1;s<r.length;s++){var l=r[s];0!==n[l]&&(a=!1)}a&&(i.splice(t--,1),e=o(o.s=r[0]))}return e}var a={},n={app:0},i=[];function o(t){if(a[t])return a[t].exports;var r=a[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=a,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)o.d(r,a,function(t){return e[t]}.bind(null,a));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],l=s.push.bind(s);s.push=t,s=s.slice();for(var u=0;u<s.length;u++)t(s[u]);var c=l;i.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("56d7")},"02d4":function(e,t,r){"use strict";r("17cf")},"17cf":function(e,t,r){var a=r("3574");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var n=r("499e").default;n("07601afd",a,!0,{sourceMap:!1,shadowMode:!1})},3574:function(e,t,r){var a=r("24fb");t=a(!1),t.push([e.i,".vlt-wrapper{position:relative;width:160px;height:200px;padding:10px;box-sizing:border-box;border:1px solid #ccc;font-size:13px}.vlt-wrapper .vlt-dialog,.vlt-wrapper .vlt-wave{position:absolute;width:calc(100% - 20px)}.vlt-wrapper .vlt-wave{height:100px;top:10px;left:10px}.vlt-wrapper .vlt-runlog{color:red;position:absolute;left:0;bottom:5px;width:100%;height:30px;line-height:30px}.vlt-wrapper .vlt-volume,.vlt-wrapper .vlt-volume input{width:100%}",""]),e.exports=t},"56d7":function(e,t,r){"use strict";r.r(t);var a=r("2b0e"),n=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("div",{staticClass:"center"},[t("vue-live-talk",{ref:"talk",attrs:{sampleRate:e.sampleRateValue}})],1),t("div",{staticClass:"around"},[t("div",{staticClass:"device"},[t("label",{attrs:{for:"imei"}},[e._v("Imei")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.imei,expression:"imei"}],attrs:{type:"text",name:"imei"},domProps:{value:e.imei},on:{input:function(t){t.target.composing||(e.imei=t.target.value)}}})]),t("div",{staticClass:"device"},[t("label",{attrs:{for:"chn"}},[e._v("Chn")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.chn,expression:"chn"}],attrs:{type:"text",name:"chn"},domProps:{value:e.chn},on:{input:function(t){t.target.composing||(e.chn=t.target.value)}}})])]),t("div",{staticClass:"around"},[t("div",{staticClass:"url"},[t("label",{attrs:{for:"url"}},[e._v("WS Url")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.url,expression:"url"}],attrs:{type:"text",name:"url"},domProps:{value:e.url},on:{input:function(t){t.target.composing||(e.url=t.target.value)}}})])]),t("div",{staticClass:"around"},[t("div",{staticClass:"device"},[t("label",[e._v("Sample Rate")]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.sample_rate,expression:"sample_rate"}],attrs:{disabled:e.disabled},on:{change:function(t){var r=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.sample_rate=t.target.multiple?r:r[0]}}},e._l(e.sample_list,(function(r){return t("option",{key:r.id},[e._v(" "+e._s(r.val)+" ")])})),0)])]),t("div",{staticClass:"around"},[t("button",{on:{click:e.talk}},[e._v("打开对讲")]),t("button",{on:{click:e.close}},[e._v("关闭对讲")])])])},i=[],o=function(){var e=this,t=e._self._c;return t("div",{staticClass:"vlt-wrapper"},[e.showDialog?t("div",{staticClass:"vlt-dialog"},[t("div",[e._v(e._s(e.local.permission))]),t("button",[e._v(e._s(e.local.cancel))])]):e._e(),t("div",[t("svg",{staticClass:"icon",attrs:{t:"1641739095332",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"30001",width:"100",height:"120"}},[t("path",{attrs:{d:"M746.666667 405.333333a21.333333 21.333333 0 0 0-21.333334 21.333334v106.666666a213.333333 213.333333 0 0 1-426.666666 0v-106.666666a21.333333 21.333333 0 0 0-42.666667 0v106.666666a256 256 0 0 0 234.666667 256v106.666667h-128a21.333333 21.333333 0 0 0 0 42.666667h298.666666a21.333333 21.333333 0 1 0 0-42.666667h-128v-106.666667a256 256 0 0 0 234.666667-256v-106.666666a21.333333 21.333333 0 0 0-21.333333-21.333334z","p-id":"30002",fill:"#e6e6e6"}}),t("path",{attrs:{d:"M512 704a170.666667 170.666667 0 0 0 170.666667-170.666667V256a170.666667 170.666667 0 0 0-341.333334 0v277.333333a170.666667 170.666667 0 0 0 170.666667 170.666667z m-128-448a128 128 0 0 1 256 0v277.333333a128 128 0 0 1-256 0z","p-id":"30003",fill:"#e6e6e6"}})])]),t("div",{ref:"wave",staticClass:"vlt-wave"}),t("div",{staticClass:"vlt-volume"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.volume,expression:"volume"}],attrs:{type:"range",min:"0.0",max:"1.0",step:"0.01"},domProps:{value:e.volume},on:{__r:function(t){e.volume=t.target.value}}})]),t("div",{staticClass:"vlt-runlog"},[e._v(e._s(e.runlog))]),t("div",{staticClass:"vlt-player"})])},s=[],l=(r("907a"),r("986a"),r("1d02"),r("3c5d"),r("d308")),u=r.n(l);r("6f53"),r("7ae1"),r("7226");const c=function(e){return f(e)?Object.keys(e):[]};function f(e){return!!e&&"object"===typeof e}function p(e){return f(e)&&"[object Object]"===toString.call(e)&&e.constructor===Object}function h(e,t){c(e).forEach(r=>t(e[r],r))}function d(...e){const t={};return e.forEach(e=>{e&&h(e,(e,r)=>{p(e)?(p(t[r])||(t[r]={}),t[r]=d(t[r],e)):t[r]=e})}),t}const v="pcm",m={url:"ws://localhost:9090/ws/talk",imei:"10007012346",chn:0};var g={name:"VueLiveTalk",props:{local:{type:Object,default(){return{busy:"设备繁忙",cancel:"忽略",connecting:"连接中",connected:"已连接(等待设备语音)",disconnected:"已断开",error:"错误",errCodec:"不支持的编码",errCross:"无权录音(跨域)",errHttps:"无权录音(需https)",errSocket:"连接错误",errSupport:"此浏览器不支持录音",init:"未启动",noAllow:"用户拒绝录音权限",noMic:"无可用麦克风",offline:"终端掉线",talking:"通话中",timeout:"终端超时",kickout:"会话冲突"}}},sampleRate:{type:Number,default:16e3}},data(){return{bitRate:16,options:m,otherError:"",player:null,sendTime:0,sendChunk:null,showDialog:!1,socket:null,status:0,recorder:null,volume:.5,wave:null}},computed:{runlog(){let e="";switch(this.status){case 0:e=this.local.init;break;case 1:e=this.local.connecting;break;case 2:e=this.local.connected;break;case 3:e=this.local.disconnected;break;case 4:e=this.local.errSocket;break;case 5:e=this.local.noAllow;break;case 6:e=this.local.talking;break;case 7:e=this.local.errCross;break;case 8:e=this.local.errHttps;break;case 9:e=this.local.noMic;break;case 99:e=this.local.error;break;case 3e3:e=this.local.error;break;case 3001:e=this.local.timeout;break;case 3002:e=this.local.busy;break;case 3003:e=this.local.errCodec;break;case 3004:e=this.local.kickout;break;case 3005:e=this.local.offline;break}return e}},methods:{close(e){this.player&&(this.player.stop(),this.player=null),this.socket&&(this.socket.close(),this.socket=null),this.recordStop(),this.recordClose(),!1!==e&&void 0!==e||(this.status=0)},createRecord(){this.recorder=u()({type:v,sampleRate:this.sampleRate,bitRate:this.bitRate,audioTrackSet:{echoCancellation:!0,noiseSuppression:!0},onProcess:(e,t,r,a,n,i)=>{this.drawWave(e[e.length-1],t,a),this.realTimeOnProcess(e,t,r,a,n,i)}})},createPlayer(e){this.player&&(this.player.stop(),this.player=null),this.player=u.a.BufferStreamPlayer({decode:!1,onInputError:(e,t)=>{window.console.log("第"+t+"次的音频片段input输入出错: "+e,1)},transform:(t,r,a,n)=>{r=e,a(new Int16Array(t),r)}}),this.player.set.realtime=!1,this.player.start(()=>{},e=>{window.console.Log("播放器打开失败: "+e)})},createWs(){if("undefined"===typeof WebSocket)window.console.log("您的浏览器不支持WebSocket");else{this.status=1;const e=this.options.url.substr(this.options.url.length-1,this.options.url.length);"/"===e&&(this.options.url=this.options.url.substr(0,this.options.url.length-1)),this.socket=new WebSocket(this.options.url+"/"+this.options.imei+"/pcm/"+this.sampleRate+"/"+this.options.chn),this.socket.onopen=()=>{this.status=2},this.socket.onmessage=e=>{this.processMsg(e.data)},this.socket.onclose=e=>{e.code>2999?this.status=e.code:this.status=3},this.socket.onerror=e=>{this.status=4}}},drawWave(e,t,r){const a=Int16Array.from(e);this.wave.input(a,t,r)},playBuffer(e,t){this.status=6,null==this.player&&this.createPlayer(t),this.player&&this.player.input(e)},processMsg(e){null!==e&&e.arrayBuffer().then(e=>{this.playBuffer(e,this.sampleRate)})},realTimeOnProcess(e,t,r,a,n){this.sendChunk=null;const i=e;this.scaleSamples(i[0],0,i[0].length,this.volume);const o=u.a.SampleData(e,a,this.sampleRate,this.sendChunk,{frameType:v});if(this.recorder.buffers=[],0===o.data.length)return;console.log("chunk.data.length",o.data.length);const s=new Uint8Array(o.data.buffer);this.transferUpload(s)},recordOpen(){this.recorder.open(()=>{this.showDialog=!1,this.wave=u.a.FrequencyHistogramView({elem:this.$refs.wave,lineCount:15,position:0,minHeight:1,fallDuration:400,stripeEnable:!1,mirrorEnable:!0}),this.createWs(),this.recordStart()},(e,t)=>{this.showDialog=!1,t?this.status=5:(-1!==e.indexOf("跨域")&&(this.status=7),-1!==e.indexOf("https")&&(this.status=8),-1!==e.indexOf("麦克风")&&(this.status=9),7===this.status||8===this.status||9===this.status||(this.otherError=e,this.status=99))})},recordClose(){this.recorder&&this.recorder.close()},recordStart(){this.recorder&&u.a.IsOpen()&&this.recorder.start()},recordStop(){this.recorder&&u.a.IsOpen()&&this.recorder.stop()},scaleSamples(e,t,r,a){const n=1,i=Math.floor(4096*a),o=t*n,s=o+r*n;for(let l=o;l<s;l++){let t=e[l]*i>>12;t>32767?t=32767:t<-32767&&(t=-32767),e[l]=t}},talk(e){this.options=d(this.options,e),this.close(),this.recordOpen()},transferUpload(e){e&&this.socket&&1===this.socket.readyState&&this.socket.send(e)},sleep(e){var t=new Date,r=t.getTime()+e;while(1)if(console.log("sleep...."),t=new Date,t.getTime()>r)return}},watch:{status(e){(3===e||4===e||e>2999)&&this.close(!0)}},created(){},mounted(){this.createRecord()},beforeDestroy(){this.close()},destroyed(){u.a.Destroy()}},w=g,b=(r("02d4"),r("2877")),y=Object(b["a"])(w,o,s,!1,null,null,null),S=y.exports,_={name:"App",components:{VueLiveTalk:S},computed:{modeValue(){return parseInt(this.mode)},sampleRateValue(){return parseInt(this.sample_rate)}},data(){return{disabled:!1,imei:"10007012346",chn:0,url:"wss://video.flmcloud.com:8090/ws/talk",sample_rate:8e3,sample_list:[{id:0,val:8e3},{id:1,val:11025},{id:2,val:16e3},{id:3,val:22050},{id:4,val:32e3},{id:5,val:44100},{id:6,val:48e3}]}},methods:{talk(){this.$refs.talk.talk({url:this.url,imei:this.imei,chn:this.chn}),this.disabled=!0},close(){this.disabled=!1,this.$refs.talk.close()}}},x=_,M=(r("5e30"),Object(b["a"])(x,n,i,!1,null,null,null)),k=M.exports;a["a"].config.productionTip=!1,new a["a"]({render:e=>e(k)}).$mount("#app")},"5e30":function(e,t,r){"use strict";r("d04c")},"6a34":function(e,t,r){var a=r("24fb");t=a(!1),t.push([e.i,"#app{font-family:Avenir,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-align:center;color:#2c3e50;margin-top:30px}.center{margin:10px}.around,.center{display:flex;justify-content:center}.around{margin-top:18px}.around button{margin-left:5px;margin-right:5px;padding:5px;width:80px}.around input{padding:5px}.around select{padding:5px;margin-left:5px;width:90px}.device input{width:90px;margin-left:8px;margin-right:8px}.url input{width:280px;margin-left:8px}.mode{margin-left:10px;margin-right:0}.mode input{margin-right:12px}",""]),e.exports=t},"6f53":function(e,t,r){r("d9e2"),r("907a"),r("986a"),r("1d02"),r("3c5d"),function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t=this,r={scale:2,fps:20,lineCount:30,widthRatio:.6,spaceWidth:0,minHeight:0,position:-1,mirrorEnable:!1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(e,t){}};for(var a in e)r[a]=e[a];t.set=e=r;var n=e.elem;n&&("string"==typeof n?n=document.querySelector(n):n.length&&(n=n[0])),n&&(e.width=n.offsetWidth,e.height=n.offsetHeight);var i=e.scale,o=e.width*i,s=e.height*i,l=t.elem=document.createElement("div"),u=["","transform-origin:0 0;","transform:scale("+1/i+");"];l.innerHTML='<div style="width:'+e.width+"px;height:"+e.height+'px;overflow:hidden"><div style="width:'+o+"px;height:"+s+"px;"+u.join("-webkit-")+u.join("-ms-")+u.join("-moz-")+u.join("")+'"><canvas/></div></div>';var c=t.canvas=l.querySelector("canvas");t.ctx=c.getContext("2d");if(c.width=o,c.height=s,n&&(n.innerHTML="",n.appendChild(l)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");t.fft=Recorder.LibFFT(1024),t.lastH=[],t.stripesH=[]};t.prototype=e.prototype={genLinear:function(e,t,r,a){for(var n=e.createLinearGradient(0,r,0,a),i=0;i<t.length;)n.addColorStop(t[i++],t[i++]);return n},input:function(e,t,r){var a=this;a.sampleRate=r,a.pcmData=e,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var e=this,t=e.set,r=Math.floor(1e3/t.fps);e.timer||(e.timer=setInterval((function(){e.schedule()}),r));var a=Date.now(),n=e.drawTime||0;if(a-e.inputTime>1.3*t.stripeFallDuration)return clearInterval(e.timer),void(e.timer=0);if(!(a-n<r)){e.drawTime=a;for(var i=e.fft.bufferSize,o=e.pcmData,s=e.pcmPos,l=new Int16Array(i),u=0;u<i&&s<o.length;u++,s++)l[u]=o[s];e.pcmPos=s;var c=e.fft.transform(l);e.draw(c,e.sampleRate)}},draw:function(e,t){var r=this,a=r.set,n=r.ctx,i=a.scale,o=a.width*i,s=a.height*i,l=a.lineCount,u=r.fft.bufferSize,c=a.position,f=Math.abs(a.position),p=1==c?0:s,h=s;f<1&&(h/=2,p=h,h=Math.floor(h*(1+f)),p=Math.floor(c>0?p*(1-f):p*(1+f)));for(var d=r.lastH,v=r.stripesH,m=Math.ceil(h/(a.fallDuration/(1e3/a.fps))),g=Math.ceil(h/(a.stripeFallDuration/(1e3/a.fps))),w=a.stripeMargin*i,b=1<<(Math.round(Math.log(u)/Math.log(2)+3)<<1),y=Math.log(b)/Math.log(10),S=20*Math.log(32767)/Math.log(10),_=u/2,x=Math.min(_,Math.floor(5e3*_/(t/2))),M=x==_,k=M?l:Math.round(.8*l),R=x/k,C=M?0:(_-x)/(l-k),I=0,B=0;B<l;B++){var D=Math.ceil(I);I+=B<k?R:C;for(var O=Math.min(Math.ceil(I),_),T=0,P=D;P<O;P++)T=Math.max(T,Math.abs(e[P]));var L=T>b?Math.floor(17*(Math.log(T)/Math.log(10)-y)):0,A=h*Math.min(L/S,1);d[B]=(d[B]||0)-m,A<d[B]&&(A=d[B]),A<0&&(A=0),d[B]=A;var E=v[B]||0;if(A&&A+w>E)v[B]=A+w;else{var z=E-g;z<0&&(z=0),v[B]=z}}n.clearRect(0,0,o,s);var j=r.genLinear(n,a.linear,p,p-h),F=a.stripeLinear&&r.genLinear(n,a.stripeLinear,p,p-h)||j,U=r.genLinear(n,a.linear,p,p+h),H=a.stripeLinear&&r.genLinear(n,a.stripeLinear,p,p+h)||U;n.shadowBlur=a.shadowBlur*i,n.shadowColor=a.shadowColor;var N=a.mirrorEnable,W=N?2*l-1:l,Q=a.widthRatio,V=a.spaceWidth*i;0!=V&&(Q=(o-V*(W+1))/o);for(var q=Math.max(1*i,Math.floor(o*Q/W)),G=(o-W*q)/(W+1),$=a.minHeight*i,J=G+q/2,K=N?o/2-J:0,X=(B=0,K);B<l;B++)X+=G,Z=Math.floor(X),A=Math.max(d[B],$),0!=p&&(ee=p-A,n.fillStyle=j,n.fillRect(Z,ee,q,A)),p!=s&&(n.fillStyle=U,n.fillRect(Z,p,q,A)),X+=q;if(a.stripeEnable){var Y=a.stripeShadowBlur;n.shadowBlur=(-1==Y?a.shadowBlur:Y)*i,n.shadowColor=a.stripeShadowColor||a.shadowColor;var Z,ee,te=a.stripeHeight*i;for(B=0,X=K;B<l;B++)X+=G,Z=Math.floor(X),A=v[B],0!=p&&(ee=p-A-te,ee<0&&(ee=0),n.fillStyle=F,n.fillRect(Z,ee,q,te)),p!=s&&(ee=p+A,ee+te>s&&(ee=s-te),n.fillStyle=H,n.fillRect(Z,ee,q,te)),X+=q}if(N){var re=Math.floor(o/2);n.save(),n.scale(-1,1),n.drawImage(r.canvas,Math.ceil(o/2),0,re,s,-re,0,re,s),n.restore()}a.onDraw(e,t)}},Recorder.FrequencyHistogramView=e}()},7226:function(e,t,r){r("d9e2"),r("907a"),r("986a"),r("1d02"),r("3c5d"),function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t=this,r={play:!0,realtime:!0};for(var a in e)r[a]=e[a];t.set=e=r,e.onInputError||(e.onInputError=function(e,t){console.error("[BufferStreamPlayer]"+e)})};t.prototype=e.prototype={getAudioSrc:function(){return this._src||(this._src=(window.URL||webkitURL).createObjectURL(this.getMediaStream())),this._src},getMediaStream:function(){if(!this._dest)throw new Error("BufferStreamPlayer未start");return this._dest.stream},start:function(t,r){var a=this;a.inputN=0,a.inputQueueIdx=0,a.inputQueue=[],a.bufferSampleRate=0,a.audioBuffer=0,a.pcmBuffer=[[],[]];var n=function(e){r&&r("浏览器不支持打开BufferStreamPlayer"+(e?"："+e:""))},i=1;if(Recorder.Support()){var o=Recorder.Ctx.createBufferSource();o.start&&void 0!==o.onended||(i=0)}else i=0;if(i){var s=function(){var e=Recorder.Ctx.createMediaStreamDestination();e.channelCount=1,a._dest=e,t&&t(),a._inputProcess(),l?(console.warn("BufferStreamPlayer：此浏览器的AudioBuffer实现不支持动态特性，采用兼容模式"),a._writeInt=setInterval((function(){a._writeBad()}),10)):a._writeInt=setInterval((function(){a._writeBuffer()}),500)},l=e.BadAudioBuffer;if(a.__abTest||null!=l)setTimeout(s);else{var u=e({play:!1,sampleRate:8e3});u.__abTest=1,u.start((function(){var t=Recorder({type:"unknown",sourceStream:u.getMediaStream(),onProcess:function(r){for(var a=r[r.length-1],n=1,i=0;i<a.length;i++)if(0!=a[i]){n=0;break}n&&r.length<5||(t.close(),u.stop(),l=n,e.BadAudioBuffer=l,s())}});t.open((function(){t.start()}),n)}),n);for(var c=new Int16Array(8e3),f=0;f<8e3;f++)c[f]=~~(32767*Math.random()*2-32767);u.input(c)}}else n("")},stop:function(){var e=this;clearInterval(e._writeInt),e.inputQueue=0,e._src&&((window.URL||webkitURL).revokeObjectURL(e._src),e._src=0);var t=e.bufferSource;t&&(t.disconnect(),t.stop()),e.bufferSource=0,e.audioBuffer=0},input:function(e){var t=this,n=t.set,i=++t.inputN;if(!t.inputQueue)throw new Error("未调用start方法");n.decode?a(e,(function(e){t.inputQueue&&(r(e.data,e.sampleRate),t._input2(i,e.data,e.sampleRate))}),(function(e){t._inputErr(e,i)})):t._input2(i,e,n.sampleRate)},_input2:function(e,t,r){var a=this,n=a.set;n.transform?n.transform(t,r,(function(t,n){a.inputQueue&&(r=n||r,a._input3(e,t,r))}),(function(t){a._inputErr(t,e)})):a._input3(e,t,r)},_input3:function(e,t,r){var a=this;t&&t.subarray?r?a.bufferSampleRate&&a.bufferSampleRate!=r?a._inputErr("input调用失败：data的sampleRate="+r+"和之前的="+a.bufferSampleRate+"不同",e):(a.bufferSampleRate||(a.bufferSampleRate=r),a.inputQueue[e]=t,a._dest&&a._inputProcess()):a._inputErr("input调用失败：未提供sampleRate",e):a._inputErr("input调用失败：非pcm[Int16,...]输入时，必须解码或者使用transform转换",e)},_inputErr:function(e,t){this.inputQueue[t]=1,this.set.onInputError(e,t)},_inputProcess:function(){var t=this;if(t.bufferSampleRate){for(var r=t.inputQueue,a=t.inputQueueIdx+1;a<r.length;a++){var n=r[a];if(1!=n){if(!n)return;t.inputQueueIdx=a,r[a]=null;var i=t.pcmBuffer,o=i[0],s=i[1];if(o.length){if(s.length){var l=new Int16Array(o.length+s.length);l.set(o),l.set(s,o.length),i[0]=l}}else i[0]=s;i[1]=n}else t.inputQueueIdx=a}e.BadAudioBuffer?t._writeBad():t.audioBuffer?t._writeBuffer():t._createBuffer(!0)}},_createBuffer:function(e){var t=this,r=t.set;if(e||t.audioBuffer){var a=Recorder.Ctx,n=t.bufferSampleRate,i=60*n,o=a.createBuffer(1,i,n),s=a.createBufferSource();s.channelCount=1,s.buffer=o,s.connect(t._dest),r.play&&s.connect(a.destination),s.onended=function(){s.disconnect(),s.stop(),t._createBuffer()},s.start(),t.bufferSource=s,t.audioBuffer=o,t.audioBufferIdx=0,t._createBufferTime=Date.now(),t._writeBuffer()}},_writeBuffer:function(){var e=this,t=e.set,r=e.audioBuffer,a=e.bufferSampleRate,n=e.audioBufferIdx;if(r){var i=Math.floor((Date.now()-e._createBufferTime)/1e3*a);e.audioBufferIdx+.005*a<i&&(e.audioBufferIdx=i);var o=Math.max(0,e.audioBufferIdx-i),s=r.length-e.audioBufferIdx;if(s=Math.min(s,~~(.8*a)-o),!(s<1)){var l=e.pcmBuffer,u=l[0],c=l[1];if(u.length+c.length!=0){var f=0,p=1,h=t.realtime;while(h){var d=.15,v=o+u.length;if(v<2*d*a){var m=Math.floor(d*a-v);0==n&&m>0&&(e.audioBufferIdx=Math.max(e.audioBufferIdx,m)),h=!1;break}var g=3*a-o;u.length>g&&(u=u.subarray(u.length-g),l[0]=u),p=1.6,f=Math.min(s,Math.floor((u.length+c.length)/p));break}h||(f=Math.min(s,u.length+c.length)),f&&(e.audioBufferIdx=e._subWrite(r,f,e.audioBufferIdx,p))}}}},_writeBad:function(){var e=this,t=e.set,a=e.audioBuffer,n=e.bufferSampleRate,i=Recorder.Ctx;if(a){var o=a.length/n*1e3;if(Date.now()-e._createBufferTime<o-5)return}var s=~~(.8*n),l=t.PlayBufferDisable?0:n/1e3*300,u=e.pcmBuffer,c=u[0],f=u[1],p=c.length+f.length;if(!(0==p||p<l)){var h=0,d=1,v=t.realtime;while(v){var m=c.length;if(m<.3*n){v=!1;break}var g=3*n;c.length>g&&(c=c.subarray(c.length-g),u[0]=c),d=1.6,h=Math.min(s,Math.floor((c.length+f.length)/d));break}if(v||(h=Math.min(s,c.length+f.length)),h){a=i.createBuffer(1,h,n),e._subWrite(a,h,0,d),r(a.getChannelData(0),n);var w=i.createBufferSource();w.channelCount=1,w.buffer=a,w.connect(e._dest),t.play&&w.connect(i.destination),w.start(),e.bufferSource=w,e.audioBuffer=a,e._createBufferTime=Date.now()}}},_subWrite:function(e,t,r,a){for(var n=this,i=n.pcmBuffer,o=i[0],s=i[1],l=new Int16Array(t),u=0,c=0,f=0;c<t&&f<o.length;)l[c++]=o[u],f+=a,u=Math.round(f);if(u>=o.length){for(o=new Int16Array(0),f=0,u=0;c<t&&f<s.length;)l[c++]=s[u],f+=a,u=Math.round(f);s=u>=s.length?new Int16Array(0):s.subarray(u),i[1]=s}else o=o.subarray(u);i[0]=o;var p=e.getChannelData(0);for(u=0;u<t;u++,r++)p[r]=l[u]/32767;return r}};var r=e.FadeInOut=function(e,t){for(var r=t/1e3*1,a=0;a<r;a++)e[a]*=a/r;var n=e.length;for(a=~~(n-r);a<n;a++)e[a]*=(n-a)/r},a=e.DecodeAudio=function(e,t,r){if(Recorder.Support()){var a=Recorder.Ctx;a.decodeAudioData(e,(function(e){for(var r=e.getChannelData(0),a=e.sampleRate,n=new Int16Array(r.length),i=0;i<r.length;i++){var o=Math.max(-1,Math.min(1,r[i]));o=o<0?32768*o:32767*o,n[i]=o}t&&t({sampleRate:a,duration:Math.round(r.length/a*1e3),data:n})}),(function(e){r&&r("音频解码失败:"+(e&&e.message||"-"))}))}else r&&r("浏览器不支持音频解码")};Recorder.BufferStreamPlayer=e}()},"7ae1":function(e,t,r){r("907a"),r("986a"),r("1d02"),r("3c5d"),Recorder.LibFFT=function(e){"use strict";var t,r,a,n,i,o,s,l,u=function(e){var u,c,f,p;for(t=Math.round(Math.log(e)/Math.log(2)),r=1<<t,a=(r<<2)*Math.sqrt(2),n=[],i=[],o=[0],s=[0],l=[],u=0;u<r;u++){for(f=u,c=0,p=0;c!=t;c++)p<<=1,p|=1&f,f>>>=1;l[u]=p}var h,d=2*Math.PI/r;for(u=(r>>1)-1;u>0;u--)h=u*d,s[u]=Math.cos(h),o[u]=Math.sin(h)},c=function(e){var u,c,f,p,h,d,v,m,g=1,w=t-1;for(u=0;u!=r;u++)n[u]=e[l[u]],i[u]=0;for(u=t;0!=u;u--){for(c=0;c!=g;c++)for(h=s[c<<w],d=o[c<<w],f=c;f<r;f+=g<<1)p=f+g,v=h*n[p]-d*i[p],m=h*i[p]+d*n[p],n[p]=n[f]-v,i[p]=i[f]-m,n[f]+=v,i[f]+=m;g<<=1,w--}c=r>>1;var b=new Float64Array(c);for(d=a,h=-a,u=c;0!=u;u--)v=n[u],m=i[u],b[u-1]=v>h&&v<d&&m>h&&m<d?0:Math.round(v*v+m*m);return b};return u(e),{transform:c,bufferSize:r}}},d04c:function(e,t,r){var a=r("6a34");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var n=r("499e").default;n("6c6c8dcd",a,!0,{sourceMap:!1,shadowMode:!1})},d308:function(e,t,r){var a;r("907a"),r("986a"),r("1d02"),r("3c5d"),r("14d9"),function(n){n(window),a=function(){return Recorder}.call(t,r,t,e),void 0===a||(e.exports=a),e.exports&&(e.exports=Recorder)}((function(e){"use strict";var t="2021-08-03 20:01:03",r=function(){},a=function(e){return new u(e)};a.IsOpen=function(){var e=a.Stream;if(e){var t=e.getTracks&&e.getTracks()||e.audioTracks||[],r=t[0];if(r){var n=r.readyState;return"live"==n||n==r.LIVE}}return!1},a.BufferSize=4096,a.Destroy=function(){for(var e in s("Recorder Destroy"),o(),n)n[e]()};var n={};a.BindDestroy=function(e,t){n[e]=t},a.Support=function(){var t=e.AudioContext;if(t||(t=e.webkitAudioContext),!t)return!1;var r=navigator.mediaDevices||{};return r.getUserMedia||(r=navigator,r.getUserMedia||(r.getUserMedia=r.webkitGetUserMedia||r.mozGetUserMedia||r.msGetUserMedia)),!!r.getUserMedia&&(a.Scope=r,a.Ctx&&"closed"!=a.Ctx.state||(a.Ctx=new t,a.BindDestroy("Ctx",(function(){var e=a.Ctx;e&&e.close&&(e.close(),a.Ctx=0)}))),!0)};var i=function(e){e=e||a;var t=e.BufferSize||a.BufferSize,r=a.Ctx,n=e.Stream,i=n._m=r.createMediaStreamSource(n),o=n._p=(r.createScriptProcessor||r.createJavaScriptNode).call(r,t,1,1);i.connect(o),o.connect(r.destination);var s=n._call;o.onaudioprocess=function(e){for(var t in s){for(var r=e.inputBuffer.getChannelData(0),a=r.length,n=new Int16Array(a),i=0,o=0;o<a;o++){var l=Math.max(-1,Math.min(1,r[o]));l=l<0?32768*l:32767*l,n[o]=l,i+=Math.abs(l)}for(var u in s)s[u](n,i);return}}},o=function(e){e=e||a;var t=e==a,r=e.Stream;if(r&&(r._m&&(r._m.disconnect(),r._p.disconnect(),r._p.onaudioprocess=r._p=r._m=null),t)){for(var n=r.getTracks&&r.getTracks()||r.audioTracks||[],i=0;i<n.length;i++){var o=n[i];o.stop&&o.stop()}r.stop&&r.stop()}e.Stream=0};a.SampleData=function(e,t,r,a,n){a||(a={});var i=a.index||0,o=a.offset||0,s=a.frameNext||[];n||(n={});var l=n.frameSize||1;n.frameType&&(l="mp3"==n.frameType?1152:1);for(var u=0,c=i;c<e.length;c++)u+=e[c].length;u=Math.max(0,u-Math.floor(o));var f=t/r;f>1?u=Math.floor(u/f):(f=1,r=t),u+=s.length;var p=new Int16Array(u),h=0;for(c=0;c<s.length;c++)p[h]=s[c],h++;for(var d=e.length;i<d;i++){var v=e[i],m=(c=o,v.length);while(c<m){var g=Math.floor(c),w=Math.ceil(c),b=c-g,y=v[g],S=w<m?v[w]:(e[i+1]||[y])[0]||0;p[h]=y+(S-y)*b,h++,c+=f}o=c-m}s=null;var _=p.length%l;if(_>0){var x=2*(p.length-_);s=new Int16Array(p.buffer.slice(x)),p=new Int16Array(p.buffer.slice(0,x))}return{index:i,offset:o,frameNext:s,sampleRate:r,data:p}},a.PowerLevel=function(e,t){var r,a=e/t||0;return r=a<1251?Math.round(a/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(a/1e4)/Math.log(10))))),r},a.showLog=!1;var s=function(e,t){if(a.showLog){var r=new Date,n=("0"+r.getMinutes()).substr(-2)+":"+("0"+r.getSeconds()).substr(-2)+"."+("00"+r.getMilliseconds()).substr(-3),i=["["+n+" Recorder]"+e],o=arguments,s=2,l=console.log;for("number"==typeof t?l=1==t?console.error:3==t?console.warn:l:s=1;s<o.length;s++)i.push(o[s]);l.apply(console,i)}};a.CLog=s;var l=0;function u(e){this.id=++l;var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:r};for(var a in e)t[a]=e[a];this.set=t,this._S=9,this.Sync={O:9,C:9}}a.Sync={O:9,C:9},a.prototype=u.prototype={_streamStore:function(){return this.set.sourceStream?this:a},open:function(t,n){var l=this,u=l._streamStore();t=t||r;var c=function(e,t){t=!!t,s("录音open失败："+e+",isUserNotAllow:"+t,1),n&&n(e,t)},f=function(){s("open成功"),t(),l._SO=0},p=u.Sync,h=++p.O,d=p.C;l._O=l._O_=h,l._SO=l._S;var v=function(){if(d!=p.C||!l._O){var e="open被取消";return h==p.O?l.close():e="open被中断",c(e),!0}},m=l.envCheck({envName:"H5",canProcess:!0});if(m)c("不能录音："+m);else if(l.set.sourceStream){if(!a.Support())return void c("不支持此浏览器从流中获取录音");o(u),l.Stream=l.set.sourceStream,l.Stream._call={};try{i(u)}catch(S){return void c("从流中打开录音失败："+S.message)}f()}else{var g=function(t,r){try{e.top.a}catch(S){return void c('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(t)?c("用户拒绝了录音权限",!0):!1===e.isSecureContext?c("无权录音(需https)"):/Found/i.test(t)?c(r+"，无可用麦克风"):c(r)};if(a.IsOpen())f();else if(a.Support()){var w=function(e){a.Stream=e,e._call={},v()||setTimeout((function(){v()||(a.IsOpen()?(i(),f()):c("录音功能无效：无音频流"))}),100)},b=function(e){var t=e.name||e.message||e.code+":"+e;s("请求录音权限错误",1,e),g(t,"无法录音："+t)},y=a.Scope.getUserMedia({audio:l.set.audioTrackSet||!0},w,b);y&&y.then&&y.then(w)[t&&"catch"](b)}else g("","此浏览器不支持录音")}},close:function(e){e=e||r;var t=this,a=t._streamStore();t._stop();var n=a.Sync;if(t._O=0,t._O_!=n.O)return s("close被忽略",3),void e();n.C++,o(a),s("close"),e()},mock:function(e,t){var r=this;return r._stop(),r.isMock=1,r.mockEnvInfo=null,r.buffers=[e],r.recSize=e.length,r.srcSampleRate=t,r},envCheck:function(e){var t,r=this,a=r.set;return t||(r[a.type+"_envCheck"]?t=r[a.type+"_envCheck"](e,a):a.takeoffEncodeChunk&&(t=a.type+"类型不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var r=this,a=r.set;if(r.isMock=e?1:0,r.mockEnvInfo=e,r.buffers=[],r.recSize=0,r.envInLast=0,r.envInFirst=0,r.envInFix=0,r.envInFixTs=[],a.sampleRate=Math.min(t,a.sampleRate),r.srcSampleRate=t,r.engineCtx=0,r[a.type+"_start"]){var n=r.engineCtx=r[a.type+"_start"](a);n&&(n.pcmDatas=[],n.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var r=this,n=r.set,i=r.engineCtx,o=r.srcSampleRate,l=e.length,u=a.PowerLevel(t,l),c=r.buffers,f=c.length;c.push(e);var p=c,h=f,d=Date.now(),v=Math.round(l/o*1e3);r.envInLast=d,1==r.buffers.length&&(r.envInFirst=d-v);var m=r.envInFixTs;m.splice(0,0,{t:d,d:v});for(var g=d,w=0,b=0;b<m.length;b++){var y=m[b];if(d-y.t>3e3){m.length=b;break}g=y.t,w+=y.d}var S=m[1],_=d-g,x=_-w;if(x>_/3&&(S&&_>1e3||m.length>=6)){var M=d-S.t-v;if(M>v/5){var k=!n.disableEnvInFix;if(s("["+d+"]"+(k?"":"未")+"补偿"+M+"ms",3),r.envInFix+=M,k){var R=new Int16Array(M*o/1e3);l+=R.length,c.push(R)}}}var C=r.recSize,I=l,B=C+I;if(r.recSize=B,i){var D=a.SampleData(c,o,n.sampleRate,i.chunkInfo);i.chunkInfo=D,C=i.pcmSize,I=D.data.length,B=C+I,i.pcmSize=B,c=i.pcmDatas,f=c.length,c.push(D.data),o=D.sampleRate}var O=Math.round(B/o*1e3),T=c.length,P=p.length,L=function(){for(var e=A?0:-I,t=null==c[0],a=f;a<T;a++){var o=c[a];null==o?t=1:(e+=o.length,i&&o.length&&r[n.type+"_encode"](i,o))}if(t&&i){a=h;for(p[0]&&(a=0);a<P;a++)p[a]=null}t&&(e=A?I:0,c[0]=null),i?i.pcmSize+=e:r.recSize+=e},A=n.onProcess(c,u,O,o,f,L);if(!0===A){var E=0;for(b=f;b<T;b++)null==c[b]?E=1:c[b]=new Int16Array(0);E?s("未进入异步前不能清除buffers",3):i?i.pcmSize-=I:r.recSize-=I}else L()},start:function(){var e=this,t=a.Ctx,r=1;if(e.set.sourceStream?e.Stream||(r=0):a.IsOpen()||(r=0),r)if(s("开始录音"),e._stop(),e.state=0,e.envStart(null,t.sampleRate),e._SO&&e._SO+1!=e._S)s("start被中断",3);else{e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then((function(){s("ctx resume"),n()})):n()}else s("未open",1)},pause:function(){var e=this;e.state&&(e.state=2,s("pause"),delete e._streamStore().Stream._call[e.id])},resume:function(){var e=this;e.state&&(e.state=1,s("resume"),e.envResume(),e._streamStore().Stream._call[e.id]=function(t,r){1==e.state&&e.envIn(t,r)})},_stop:function(e){var t=this,r=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[r.type+"_stop"]&&(t[r.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(e,t,r){var n,i=this,o=i.set;s("Stop "+(i.envInLast?i.envInLast-i.envInFirst+"ms 补"+i.envInFix+"ms":"-"));var l=function(){i._stop(),r&&i.close()},u=function(e){s("结束录音失败："+e,1),t&&t(e),l()},c=function(t,r){if(s("结束录音 编码"+(Date.now()-n)+"ms 音频"+r+"ms/"+t.size+"b"),o.takeoffEncodeChunk)s("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(t.size<Math.max(100,r/2))return void u("生成的"+o.type+"无效");e&&e(t,r),l()};if(!i.isMock){if(!i.state)return void u("未开始录音");i._stop(!0)}var f=i.recSize;if(f)if(i.buffers[0])if(i[o.type]){if(i.isMock){var p=i.envCheck(i.mockEnvInfo||{envName:"mock",canProcess:!1});if(p)return void u("录音错误："+p)}var h=i.engineCtx;if(i[o.type+"_complete"]&&h){var d=Math.round(h.pcmSize/o.sampleRate*1e3);return n=Date.now(),void i[o.type+"_complete"](h,(function(e){c(e,d)}),u)}n=Date.now();var v=a.SampleData(i.buffers,i.srcSampleRate,o.sampleRate);o.sampleRate=v.sampleRate;var m=v.data;d=Math.round(m.length/o.sampleRate*1e3);s("采样"+f+"->"+m.length+" 花:"+(Date.now()-n)+"ms"),setTimeout((function(){n=Date.now(),i[o.type](m,(function(e){c(e,d)}),(function(e){u(e)}))}))}else u("未加载"+o.type+"编码器");else u("音频被释放");else u("未采集到录音")}},e.Recorder&&e.Recorder.Destroy(),e.Recorder=a,a.LM=t}))}});