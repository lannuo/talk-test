(function(e){function t(t){for(var a,i,s=t[0],l=t[1],c=t[2],f=0,p=[];f<s.length;f++)i=s[f],Object.prototype.hasOwnProperty.call(n,i)&&n[i]&&p.push(n[i][0]),n[i]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a]);u&&u(t);while(p.length)p.shift()();return o.push.apply(o,c||[]),r()}function r(){for(var e,t=0;t<o.length;t++){for(var r=o[t],a=!0,s=1;s<r.length;s++){var l=r[s];0!==n[l]&&(a=!1)}a&&(o.splice(t--,1),e=i(i.s=r[0]))}return e}var a={},n={app:0},o=[];function i(t){if(a[t])return a[t].exports;var r=a[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=a,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(r,a,function(t){return e[t]}.bind(null,a));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],l=s.push.bind(s);s.push=t,s=s.slice();for(var c=0;c<s.length;c++)t(s[c]);var u=l;o.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("56d7")},"0554":function(e,t,r){var a=r("96a4");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var n=r("499e").default;n("8de89716",a,!0,{sourceMap:!1,shadowMode:!1})},"1a7e":function(e,t,r){var a=r("24fb");t=a(!1),t.push([e.i,".vlt-wrapper{position:relative;width:160px;height:200px;padding:10px;box-sizing:border-box;border:1px solid #ccc;font-size:13px}.vlt-wrapper .vlt-dialog,.vlt-wrapper .vlt-wave{position:absolute;width:calc(100% - 20px)}.vlt-wrapper .vlt-wave{height:100px;top:10px;left:10px}.vlt-wrapper .vlt-runlog{color:red;position:absolute;left:0;bottom:5px;width:100%;height:30px;line-height:30px}.vlt-wrapper .vlt-volume,.vlt-wrapper .vlt-volume input{width:100%}",""]),e.exports=t},"2bb3":function(e,t,r){var a=r("1a7e");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var n=r("499e").default;n("007361bf",a,!0,{sourceMap:!1,shadowMode:!1})},"56d7":function(e,t,r){"use strict";r.r(t);r("e260"),r("e6cf"),r("cca6"),r("a79d");var a=r("2b0e"),n=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"app"}},[r("div",{staticClass:"center"},[r("vue-live-talk",{ref:"talk",attrs:{sampleRate:e.sampleRateValue}})],1),r("div",{staticClass:"around"},[r("div",{staticClass:"device"},[r("label",{attrs:{for:"imei"}},[e._v("Imei")]),r("input",{directives:[{name:"model",rawName:"v-model",value:e.imei,expression:"imei"}],attrs:{type:"text",name:"imei"},domProps:{value:e.imei},on:{input:function(t){t.target.composing||(e.imei=t.target.value)}}})]),r("div",{staticClass:"device"},[r("label",{attrs:{for:"chn"}},[e._v("Chn")]),r("input",{directives:[{name:"model",rawName:"v-model",value:e.chn,expression:"chn"}],attrs:{type:"text",name:"chn"},domProps:{value:e.chn},on:{input:function(t){t.target.composing||(e.chn=t.target.value)}}})])]),r("div",{staticClass:"around"},[r("div",{staticClass:"url"},[r("label",{attrs:{for:"url"}},[e._v("WS Url")]),r("input",{directives:[{name:"model",rawName:"v-model",value:e.url,expression:"url"}],attrs:{type:"text",name:"url"},domProps:{value:e.url},on:{input:function(t){t.target.composing||(e.url=t.target.value)}}})])]),r("div",{staticClass:"around"},[r("div",{staticClass:"device"},[r("label",[e._v("Sample Rate")]),r("select",{directives:[{name:"model",rawName:"v-model",value:e.sample_rate,expression:"sample_rate"}],attrs:{disabled:e.disabled},on:{change:function(t){var r=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.sample_rate=t.target.multiple?r:r[0]}}},e._l(e.sample_list,(function(t){return r("option",{key:t.id},[e._v(" "+e._s(t.val)+" ")])})),0)])]),r("div",{staticClass:"around"},[r("button",{on:{click:e.talk}},[e._v("打开对讲")]),r("button",{on:{click:e.close}},[e._v("关闭对讲")])])])},o=[],i=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"vlt-wrapper"},[e.showDialog?r("div",{staticClass:"vlt-dialog"},[r("div",[e._v(e._s(e.local.permission))]),r("button",[e._v(e._s(e.local.cancel))])]):e._e(),r("div",[r("svg",{staticClass:"icon",attrs:{t:"1641739095332",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"30001",width:"100",height:"120"}},[r("path",{attrs:{d:"M746.666667 405.333333a21.333333 21.333333 0 0 0-21.333334 21.333334v106.666666a213.333333 213.333333 0 0 1-426.666666 0v-106.666666a21.333333 21.333333 0 0 0-42.666667 0v106.666666a256 256 0 0 0 234.666667 256v106.666667h-128a21.333333 21.333333 0 0 0 0 42.666667h298.666666a21.333333 21.333333 0 1 0 0-42.666667h-128v-106.666667a256 256 0 0 0 234.666667-256v-106.666666a21.333333 21.333333 0 0 0-21.333333-21.333334z","p-id":"30002",fill:"#e6e6e6"}}),r("path",{attrs:{d:"M512 704a170.666667 170.666667 0 0 0 170.666667-170.666667V256a170.666667 170.666667 0 0 0-341.333334 0v277.333333a170.666667 170.666667 0 0 0 170.666667 170.666667z m-128-448a128 128 0 0 1 256 0v277.333333a128 128 0 0 1-256 0z","p-id":"30003",fill:"#e6e6e6"}})])]),r("div",{ref:"wave",staticClass:"vlt-wave"}),r("div",{staticClass:"vlt-volume"},[r("input",{directives:[{name:"model",rawName:"v-model",value:e.volume,expression:"volume"}],attrs:{type:"range",min:"0.0",max:"1.0",step:"0.01"},domProps:{value:e.volume},on:{__r:function(t){e.volume=t.target.value}}})]),r("div",{staticClass:"vlt-runlog"},[e._v(e._s(e.runlog))]),r("div",{staticClass:"vlt-player"})])},s=[],l=(r("a9e3"),r("d3b7"),r("8b09"),r("907a"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),r("20bf"),r("5cc6"),r("d308")),c=r.n(l),u=(r("6f53"),r("7ae1"),r("7226"),r("53ca")),f=(r("b64b"),r("159b"),function(e){return p(e)?Object.keys(e):[]});function p(e){return!!e&&"object"===Object(u["a"])(e)}function d(e){return p(e)&&"[object Object]"===toString.call(e)&&e.constructor===Object}function h(e,t){f(e).forEach((function(r){return t(e[r],r)}))}function v(){for(var e={},t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return r.forEach((function(t){t&&h(t,(function(t,r){d(t)?(d(e[r])||(e[r]={}),e[r]=v(e[r],t)):e[r]=t}))})),e}var m="pcm",g={url:"ws://localhost:9090/ws/talk",imei:"10007012346",chn:0},b={name:"VueLiveTalk",props:{local:{type:Object,default:function(){return{busy:"设备繁忙",cancel:"忽略",connecting:"连接中",connected:"已连接(等待设备语音)",disconnected:"已断开",error:"错误",errCodec:"不支持的编码",errCross:"无权录音(跨域)",errHttps:"无权录音(需https)",errSocket:"连接错误",errSupport:"此浏览器不支持录音",init:"未启动",noAllow:"用户拒绝录音权限",noMic:"无可用麦克风",offline:"终端掉线",talking:"通话中",timeout:"终端超时",kickout:"会话冲突"}}},sampleRate:{type:Number,default:16e3}},data:function(){return{bitRate:16,options:g,otherError:"",player:null,sendTime:0,sendChunk:null,showDialog:!1,socket:null,status:0,recorder:null,volume:.5,wave:null}},computed:{runlog:function(){var e="";switch(this.status){case 0:e=this.local.init;break;case 1:e=this.local.connecting;break;case 2:e=this.local.connected;break;case 3:e=this.local.disconnected;break;case 4:e=this.local.errSocket;break;case 5:e=this.local.noAllow;break;case 6:e=this.local.talking;break;case 7:e=this.local.errCross;break;case 8:e=this.local.errHttps;break;case 9:e=this.local.noMic;break;case 99:e=this.local.error;break;case 3e3:e=this.local.error;break;case 3001:e=this.local.timeout;break;case 3002:e=this.local.busy;break;case 3003:e=this.local.errCodec;break;case 3004:e=this.local.kickout;break;case 3005:e=this.local.offline;break}return e}},methods:{close:function(e){this.player&&(this.player.stop(),this.player=null),this.socket&&(this.socket.close(),this.socket=null),this.recordStop(),this.recordClose(),!1!==e&&void 0!==e||(this.status=0)},createRecord:function(){var e=this;this.recorder=c()({type:m,sampleRate:this.sampleRate,bitRate:this.bitRate,audioTrackSet:{echoCancellation:!0,noiseSuppression:!0},onProcess:function(t,r,a,n,o,i){e.drawWave(t[t.length-1],r,n),e.realTimeOnProcess(t,r,a,n,o,i)}})},createPlayer:function(e){this.player&&(this.player.stop(),this.player=null),this.player=c.a.BufferStreamPlayer({decode:!1,onInputError:function(e,t){window.console.log("第"+t+"次的音频片段input输入出错: "+e,1)},transform:function(t,r,a,n){r=e,a(new Int16Array(t),r)}}),this.player.start((function(){}),(function(e){window.console.Log("播放器打开失败: "+e)}))},createWs:function(){var e=this;if("undefined"===typeof WebSocket)window.console.log("您的浏览器不支持WebSocket");else{this.status=1;var t=this.options.url.substr(this.options.url.length-1,this.options.url.length);"/"===t&&(this.options.url=this.options.url.substr(0,this.options.url.length-1)),this.socket=new WebSocket(this.options.url+"/"+this.options.imei+"?codec=pcm&sample_rate="+this.sampleRate+"&chn="+this.options.chn),this.socket.onopen=function(){e.status=2},this.socket.onmessage=function(t){e.processMsg(t.data)},this.socket.onclose=function(t){t.code>2999?e.status=t.code:e.status=3},this.socket.onerror=function(t){e.status=4}}},drawWave:function(e,t,r){var a=Int16Array.from(e);this.wave.input(a,t,r)},playBuffer:function(e,t){this.status=6,null==this.player&&this.createPlayer(t),this.player&&this.player.input(e)},processMsg:function(e){var t=this;null!==e&&e.arrayBuffer().then((function(e){t.playBuffer(e,t.sampleRate)}))},realTimeOnProcess:function(e,t,r,a,n){this.sendChunk=null;var o=e;this.scaleSamples(o[0],0,o[0].length,this.volume);var i=c.a.SampleData(e,a,this.sampleRate,this.sendChunk,{frameType:m});if(this.recorder.buffers=[],0!==i.data.length){var s=new Uint8Array(i.data.buffer);this.transferUpload(s)}},recordOpen:function(){var e=this;this.recorder.open((function(){e.showDialog=!1,e.wave=c.a.FrequencyHistogramView({elem:e.$refs.wave,lineCount:15,position:0,minHeight:1,fallDuration:400,stripeEnable:!1,mirrorEnable:!0}),e.createWs(),e.recordStart()}),(function(t,r){e.showDialog=!1,r?e.status=5:(-1!==t.indexOf("跨域")&&(e.status=7),-1!==t.indexOf("https")&&(e.status=8),-1!==t.indexOf("麦克风")&&(e.status=9),7===e.status||8===e.status||9===e.status||(e.otherError=t,e.status=99))}))},recordClose:function(){this.recorder&&this.recorder.close()},recordStart:function(){this.recorder&&c.a.IsOpen()&&this.recorder.start()},recordStop:function(){this.recorder&&c.a.IsOpen()&&this.recorder.stop()},scaleSamples:function(e,t,r,a){for(var n=1,o=Math.floor(4096*a),i=t*n,s=i+r*n,l=i;l<s;l++){var c=e[l]*o>>12;c>32767?c=32767:c<-32767&&(c=-32767),e[l]=c}},talk:function(e){this.options=v(this.options,e),this.close(),this.recordOpen()},transferUpload:function(e){e&&this.socket&&1===this.socket.readyState&&this.socket.send(e)}},watch:{status:function(e){(3===e||4===e||e>2999)&&this.close(!0)}},created:function(){},mounted:function(){this.createRecord()},beforeDestroy:function(){this.close()},destroyed:function(){c.a.Destroy()}},w=b,y=(r("eed5"),r("2877")),_=Object(y["a"])(w,i,s,!1,null,null,null),S=_.exports,x={name:"App",components:{VueLiveTalk:S},computed:{modeValue:function(){return parseInt(this.mode)},sampleRateValue:function(){return parseInt(this.sample_rate)}},data:function(){return{disabled:!1,imei:"10007012346",chn:0,url:"ws://localhost:9090/ws/talk",sample_rate:8e3,sample_list:[{id:0,val:8e3},{id:1,val:11025},{id:2,val:16e3},{id:3,val:22050},{id:4,val:32e3},{id:5,val:44100},{id:6,val:48e3}]}},methods:{talk:function(){this.$refs.talk.talk({url:this.url,imei:this.imei,chn:this.chn}),this.disabled=!0},close:function(){this.disabled=!1,this.$refs.talk.close()}}},M=x,k=(r("5c0b"),Object(y["a"])(M,n,o,!1,null,null,null)),R=k.exports;a["a"].config.productionTip=!1,new a["a"]({render:function(e){return e(R)}}).$mount("#app")},"5c0b":function(e,t,r){"use strict";r("0554")},"6f53":function(e,t,r){r("a15b"),r("e260"),r("d3b7"),r("8b09"),r("907a"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t=this,r={scale:2,fps:20,lineCount:30,widthRatio:.6,spaceWidth:0,minHeight:0,position:-1,mirrorEnable:!1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(e,t){}};for(var a in e)r[a]=e[a];t.set=e=r;var n=e.elem;n&&("string"==typeof n?n=document.querySelector(n):n.length&&(n=n[0])),n&&(e.width=n.offsetWidth,e.height=n.offsetHeight);var o=e.scale,i=e.width*o,s=e.height*o,l=t.elem=document.createElement("div"),c=["","transform-origin:0 0;","transform:scale("+1/o+");"];l.innerHTML='<div style="width:'+e.width+"px;height:"+e.height+'px;overflow:hidden"><div style="width:'+i+"px;height:"+s+"px;"+c.join("-webkit-")+c.join("-ms-")+c.join("-moz-")+c.join("")+'"><canvas/></div></div>';var u=t.canvas=l.querySelector("canvas");t.ctx=u.getContext("2d");if(u.width=i,u.height=s,n&&(n.innerHTML="",n.appendChild(l)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");t.fft=Recorder.LibFFT(1024),t.lastH=[],t.stripesH=[]};t.prototype=e.prototype={genLinear:function(e,t,r,a){for(var n=e.createLinearGradient(0,r,0,a),o=0;o<t.length;)n.addColorStop(t[o++],t[o++]);return n},input:function(e,t,r){var a=this;a.sampleRate=r,a.pcmData=e,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var e=this,t=e.set,r=Math.floor(1e3/t.fps);e.timer||(e.timer=setInterval((function(){e.schedule()}),r));var a=Date.now(),n=e.drawTime||0;if(a-e.inputTime>1.3*t.stripeFallDuration)return clearInterval(e.timer),void(e.timer=0);if(!(a-n<r)){e.drawTime=a;for(var o=e.fft.bufferSize,i=e.pcmData,s=e.pcmPos,l=new Int16Array(o),c=0;c<o&&s<i.length;c++,s++)l[c]=i[s];e.pcmPos=s;var u=e.fft.transform(l);e.draw(u,e.sampleRate)}},draw:function(e,t){var r=this,a=r.set,n=r.ctx,o=a.scale,i=a.width*o,s=a.height*o,l=a.lineCount,c=r.fft.bufferSize,u=a.position,f=Math.abs(a.position),p=1==u?0:s,d=s;f<1&&(d/=2,p=d,d=Math.floor(d*(1+f)),p=Math.floor(u>0?p*(1-f):p*(1+f)));for(var h=r.lastH,v=r.stripesH,m=Math.ceil(d/(a.fallDuration/(1e3/a.fps))),g=Math.ceil(d/(a.stripeFallDuration/(1e3/a.fps))),b=a.stripeMargin*o,w=1<<(Math.round(Math.log(c)/Math.log(2)+3)<<1),y=Math.log(w)/Math.log(10),_=20*Math.log(32767)/Math.log(10),S=c/2,x=Math.min(S,Math.floor(5e3*S/(t/2))),M=x==S,k=M?l:Math.round(.8*l),R=x/k,C=M?0:(S-x)/(l-k),I=0,B=0;B<l;B++){var D=Math.ceil(I);I+=B<k?R:C;for(var O=Math.min(Math.ceil(I),S),T=0,P=D;P<O;P++)T=Math.max(T,Math.abs(e[P]));var L=T>w?Math.floor(17*(Math.log(T)/Math.log(10)-y)):0,A=d*Math.min(L/_,1);h[B]=(h[B]||0)-m,A<h[B]&&(A=h[B]),A<0&&(A=0),h[B]=A;var E=v[B]||0;if(A&&A+b>E)v[B]=A+b;else{var z=E-g;z<0&&(z=0),v[B]=z}}n.clearRect(0,0,i,s);var j=r.genLinear(n,a.linear,p,p-d),F=a.stripeLinear&&r.genLinear(n,a.stripeLinear,p,p-d)||j,U=r.genLinear(n,a.linear,p,p+d),H=a.stripeLinear&&r.genLinear(n,a.stripeLinear,p,p+d)||U;n.shadowBlur=a.shadowBlur*o,n.shadowColor=a.shadowColor;var N=a.mirrorEnable,W=N?2*l-1:l,Q=a.widthRatio,V=a.spaceWidth*o;0!=V&&(Q=(i-V*(W+1))/i);for(var $=Math.max(1*o,Math.floor(i*Q/W)),q=(i-W*$)/(W+1),G=a.minHeight*o,J=q+$/2,K=N?i/2-J:0,X=(B=0,K);B<l;B++)X+=q,Z=Math.floor(X),A=Math.max(h[B],G),0!=p&&(ee=p-A,n.fillStyle=j,n.fillRect(Z,ee,$,A)),p!=s&&(n.fillStyle=U,n.fillRect(Z,p,$,A)),X+=$;if(a.stripeEnable){var Y=a.stripeShadowBlur;n.shadowBlur=(-1==Y?a.shadowBlur:Y)*o,n.shadowColor=a.stripeShadowColor||a.shadowColor;var Z,ee,te=a.stripeHeight*o;for(B=0,X=K;B<l;B++)X+=q,Z=Math.floor(X),A=v[B],0!=p&&(ee=p-A-te,ee<0&&(ee=0),n.fillStyle=F,n.fillRect(Z,ee,$,te)),p!=s&&(ee=p+A,ee+te>s&&(ee=s-te),n.fillStyle=H,n.fillRect(Z,ee,$,te)),X+=$}if(N){var re=Math.floor(i/2);n.save(),n.scale(-1,1),n.drawImage(r.canvas,Math.ceil(i/2),0,re,s,-re,0,re,s),n.restore()}a.onDraw(e,t)}},Recorder.FrequencyHistogramView=e}()},7226:function(e,t,r){r("e260"),r("d3b7"),r("3ca3"),r("ddb0"),r("2b3d"),r("9861"),r("8b09"),r("907a"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t=this,r={play:!0,realtime:!0};for(var a in e)r[a]=e[a];t.set=e=r,e.onInputError||(e.onInputError=function(e,t){console.error("[BufferStreamPlayer]"+e)})};t.prototype=e.prototype={getAudioSrc:function(){return this._src||(this._src=(window.URL||webkitURL).createObjectURL(this.getMediaStream())),this._src},getMediaStream:function(){if(!this._dest)throw new Error("BufferStreamPlayer未start");return this._dest.stream},start:function(t,r){var a=this;a.inputN=0,a.inputQueueIdx=0,a.inputQueue=[],a.bufferSampleRate=0,a.audioBuffer=0,a.pcmBuffer=[[],[]];var n=function(e){r&&r("浏览器不支持打开BufferStreamPlayer"+(e?"："+e:""))},o=1;if(Recorder.Support()){var i=Recorder.Ctx.createBufferSource();i.start&&void 0!==i.onended||(o=0)}else o=0;if(o){var s=function(){var e=Recorder.Ctx.createMediaStreamDestination();e.channelCount=1,a._dest=e,t&&t(),a._inputProcess(),l?(console.warn("BufferStreamPlayer：此浏览器的AudioBuffer实现不支持动态特性，采用兼容模式"),a._writeInt=setInterval((function(){a._writeBad()}),10)):a._writeInt=setInterval((function(){a._writeBuffer()}),500)},l=e.BadAudioBuffer;if(a.__abTest||null!=l)setTimeout(s);else{var c=e({play:!1,sampleRate:8e3});c.__abTest=1,c.start((function(){var t=Recorder({type:"unknown",sourceStream:c.getMediaStream(),onProcess:function(r){for(var a=r[r.length-1],n=1,o=0;o<a.length;o++)if(0!=a[o]){n=0;break}n&&r.length<5||(t.close(),c.stop(),l=n,e.BadAudioBuffer=l,s())}});t.open((function(){t.start()}),n)}),n);for(var u=new Int16Array(8e3),f=0;f<8e3;f++)u[f]=~~(32767*Math.random()*2-32767);c.input(u)}}else n("")},stop:function(){var e=this;clearInterval(e._writeInt),e.inputQueue=0,e._src&&((window.URL||webkitURL).revokeObjectURL(e._src),e._src=0);var t=e.bufferSource;t&&(t.disconnect(),t.stop()),e.bufferSource=0,e.audioBuffer=0},input:function(e){var t=this,n=t.set,o=++t.inputN;if(!t.inputQueue)throw new Error("未调用start方法");n.decode?a(e,(function(e){t.inputQueue&&(r(e.data,e.sampleRate),t._input2(o,e.data,e.sampleRate))}),(function(e){t._inputErr(e,o)})):t._input2(o,e,n.sampleRate)},_input2:function(e,t,r){var a=this,n=a.set;n.transform?n.transform(t,r,(function(t,n){a.inputQueue&&(r=n||r,a._input3(e,t,r))}),(function(t){a._inputErr(t,e)})):a._input3(e,t,r)},_input3:function(e,t,r){var a=this;t&&t.subarray?r?a.bufferSampleRate&&a.bufferSampleRate!=r?a._inputErr("input调用失败：data的sampleRate="+r+"和之前的="+a.bufferSampleRate+"不同",e):(a.bufferSampleRate||(a.bufferSampleRate=r),a.inputQueue[e]=t,a._dest&&a._inputProcess()):a._inputErr("input调用失败：未提供sampleRate",e):a._inputErr("input调用失败：非pcm[Int16,...]输入时，必须解码或者使用transform转换",e)},_inputErr:function(e,t){this.inputQueue[t]=1,this.set.onInputError(e,t)},_inputProcess:function(){var t=this;if(t.bufferSampleRate){for(var r=t.inputQueue,a=t.inputQueueIdx+1;a<r.length;a++){var n=r[a];if(1!=n){if(!n)return;t.inputQueueIdx=a,r[a]=null;var o=t.pcmBuffer,i=o[0],s=o[1];if(i.length){if(s.length){var l=new Int16Array(i.length+s.length);l.set(i),l.set(s,i.length),o[0]=l}}else o[0]=s;o[1]=n}else t.inputQueueIdx=a}e.BadAudioBuffer?t._writeBad():t.audioBuffer?t._writeBuffer():t._createBuffer(!0)}},_createBuffer:function(e){var t=this,r=t.set;if(e||t.audioBuffer){var a=Recorder.Ctx,n=t.bufferSampleRate,o=60*n,i=a.createBuffer(1,o,n),s=a.createBufferSource();s.channelCount=1,s.buffer=i,s.connect(t._dest),r.play&&s.connect(a.destination),s.onended=function(){s.disconnect(),s.stop(),t._createBuffer()},s.start(),t.bufferSource=s,t.audioBuffer=i,t.audioBufferIdx=0,t._createBufferTime=Date.now(),t._writeBuffer()}},_writeBuffer:function(){var e=this,t=e.set,r=e.audioBuffer,a=e.bufferSampleRate,n=e.audioBufferIdx;if(r){var o=Math.floor((Date.now()-e._createBufferTime)/1e3*a);e.audioBufferIdx+.005*a<o&&(e.audioBufferIdx=o);var i=Math.max(0,e.audioBufferIdx-o),s=r.length-e.audioBufferIdx;if(s=Math.min(s,~~(.8*a)-i),!(s<1)){var l=e.pcmBuffer,c=l[0],u=l[1];if(c.length+u.length!=0){var f=0,p=1,d=t.realtime;while(d){var h=.15,v=i+c.length;if(v<2*h*a){var m=Math.floor(h*a-v);0==n&&m>0&&(e.audioBufferIdx=Math.max(e.audioBufferIdx,m)),d=!1;break}var g=3*a-i;c.length>g&&(c=c.subarray(c.length-g),l[0]=c),p=1.6,f=Math.min(s,Math.floor((c.length+u.length)/p));break}d||(f=Math.min(s,c.length+u.length)),f&&(e.audioBufferIdx=e._subWrite(r,f,e.audioBufferIdx,p))}}}},_writeBad:function(){var e=this,t=e.set,a=e.audioBuffer,n=e.bufferSampleRate,o=Recorder.Ctx;if(a){var i=a.length/n*1e3;if(Date.now()-e._createBufferTime<i-5)return}var s=~~(.8*n),l=t.PlayBufferDisable?0:n/1e3*300,c=e.pcmBuffer,u=c[0],f=c[1],p=u.length+f.length;if(!(0==p||p<l)){var d=0,h=1,v=t.realtime;while(v){var m=u.length;if(m<.3*n){v=!1;break}var g=3*n;u.length>g&&(u=u.subarray(u.length-g),c[0]=u),h=1.6,d=Math.min(s,Math.floor((u.length+f.length)/h));break}if(v||(d=Math.min(s,u.length+f.length)),d){a=o.createBuffer(1,d,n),e._subWrite(a,d,0,h),r(a.getChannelData(0),n);var b=o.createBufferSource();b.channelCount=1,b.buffer=a,b.connect(e._dest),t.play&&b.connect(o.destination),b.start(),e.bufferSource=b,e.audioBuffer=a,e._createBufferTime=Date.now()}}},_subWrite:function(e,t,r,a){for(var n=this,o=n.pcmBuffer,i=o[0],s=o[1],l=new Int16Array(t),c=0,u=0,f=0;u<t&&f<i.length;)l[u++]=i[c],f+=a,c=Math.round(f);if(c>=i.length){for(i=new Int16Array(0),f=0,c=0;u<t&&f<s.length;)l[u++]=s[c],f+=a,c=Math.round(f);s=c>=s.length?new Int16Array(0):s.subarray(c),o[1]=s}else i=i.subarray(c);o[0]=i;var p=e.getChannelData(0);for(c=0;c<t;c++,r++)p[r]=l[c]/32767;return r}};var r=e.FadeInOut=function(e,t){for(var r=t/1e3*1,a=0;a<r;a++)e[a]*=a/r;var n=e.length;for(a=~~(n-r);a<n;a++)e[a]*=(n-a)/r},a=e.DecodeAudio=function(e,t,r){if(Recorder.Support()){var a=Recorder.Ctx;a.decodeAudioData(e,(function(e){for(var r=e.getChannelData(0),a=e.sampleRate,n=new Int16Array(r.length),o=0;o<r.length;o++){var i=Math.max(-1,Math.min(1,r[o]));i=i<0?32768*i:32767*i,n[o]=i}t&&t({sampleRate:a,duration:Math.round(r.length/a*1e3),data:n})}),(function(e){r&&r("音频解码失败:"+(e&&e.message||"-"))}))}else r&&r("浏览器不支持音频解码")};Recorder.BufferStreamPlayer=e}()},"7ae1":function(e,t,r){r("e260"),r("d3b7"),r("4a9b"),r("907a"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),Recorder.LibFFT=function(e){"use strict";var t,r,a,n,o,i,s,l,c=function(e){var c,u,f,p;for(t=Math.round(Math.log(e)/Math.log(2)),r=1<<t,a=(r<<2)*Math.sqrt(2),n=[],o=[],i=[0],s=[0],l=[],c=0;c<r;c++){for(f=c,u=0,p=0;u!=t;u++)p<<=1,p|=1&f,f>>>=1;l[c]=p}var d,h=2*Math.PI/r;for(c=(r>>1)-1;c>0;c--)d=c*h,s[c]=Math.cos(d),i[c]=Math.sin(d)},u=function(e){var c,u,f,p,d,h,v,m,g=1,b=t-1;for(c=0;c!=r;c++)n[c]=e[l[c]],o[c]=0;for(c=t;0!=c;c--){for(u=0;u!=g;u++)for(d=s[u<<b],h=i[u<<b],f=u;f<r;f+=g<<1)p=f+g,v=d*n[p]-h*o[p],m=d*o[p]+h*n[p],n[p]=n[f]-v,o[p]=o[f]-m,n[f]+=v,o[f]+=m;g<<=1,b--}u=r>>1;var w=new Float64Array(u);for(h=a,d=-a,c=u;0!=c;c--)v=n[c],m=o[c],w[c-1]=v>d&&v<h&&m>d&&m<h?0:Math.round(v*v+m*m);return w};return c(e),{transform:u,bufferSize:r}}},"96a4":function(e,t,r){var a=r("24fb");t=a(!1),t.push([e.i,"#app{font-family:Avenir,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-align:center;color:#2c3e50;margin-top:30px}.center{margin:10px}.around,.center{display:flex;justify-content:center}.around{margin-top:18px}.around button{margin-left:5px;margin-right:5px;padding:5px;width:80px}.around input{padding:5px}.around select{padding:5px;margin-left:5px;width:90px}.device input{width:90px;margin-left:8px;margin-right:8px}.url input{width:280px;margin-left:8px}.mode{margin-left:10px;margin-right:0}.mode input{margin-right:12px}",""]),e.exports=t},d308:function(e,t,r){(function(e){var a,n=r("7037").default;r("e260"),r("d3b7"),r("8b09"),r("907a"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),r("fb6a"),r("ac1f"),r("00b4"),r("b0c0"),r("a434"),function(o){o(window),a=function(){return Recorder}.call(t,r,t,e),void 0===a||(e.exports=a),"object"==n(e)&&e.exports&&(e.exports=Recorder)}((function(e){"use strict";var t="2021-08-03 20:01:03",r=function(){},a=function(e){return new c(e)};a.IsOpen=function(){var e=a.Stream;if(e){var t=e.getTracks&&e.getTracks()||e.audioTracks||[],r=t[0];if(r){var n=r.readyState;return"live"==n||n==r.LIVE}}return!1},a.BufferSize=4096,a.Destroy=function(){for(var e in s("Recorder Destroy"),i(),n)n[e]()};var n={};a.BindDestroy=function(e,t){n[e]=t},a.Support=function(){var t=e.AudioContext;if(t||(t=e.webkitAudioContext),!t)return!1;var r=navigator.mediaDevices||{};return r.getUserMedia||(r=navigator,r.getUserMedia||(r.getUserMedia=r.webkitGetUserMedia||r.mozGetUserMedia||r.msGetUserMedia)),!!r.getUserMedia&&(a.Scope=r,a.Ctx&&"closed"!=a.Ctx.state||(a.Ctx=new t,a.BindDestroy("Ctx",(function(){var e=a.Ctx;e&&e.close&&(e.close(),a.Ctx=0)}))),!0)};var o=function(e){e=e||a;var t=e.BufferSize||a.BufferSize,r=a.Ctx,n=e.Stream,o=n._m=r.createMediaStreamSource(n),i=n._p=(r.createScriptProcessor||r.createJavaScriptNode).call(r,t,1,1);o.connect(i),i.connect(r.destination);var s=n._call;i.onaudioprocess=function(e){for(var t in s){for(var r=e.inputBuffer.getChannelData(0),a=r.length,n=new Int16Array(a),o=0,i=0;i<a;i++){var l=Math.max(-1,Math.min(1,r[i]));l=l<0?32768*l:32767*l,n[i]=l,o+=Math.abs(l)}for(var c in s)s[c](n,o);return}}},i=function(e){e=e||a;var t=e==a,r=e.Stream;if(r&&(r._m&&(r._m.disconnect(),r._p.disconnect(),r._p.onaudioprocess=r._p=r._m=null),t)){for(var n=r.getTracks&&r.getTracks()||r.audioTracks||[],o=0;o<n.length;o++){var i=n[o];i.stop&&i.stop()}r.stop&&r.stop()}e.Stream=0};a.SampleData=function(e,t,r,a,n){a||(a={});var o=a.index||0,i=a.offset||0,s=a.frameNext||[];n||(n={});var l=n.frameSize||1;n.frameType&&(l="mp3"==n.frameType?1152:1);for(var c=0,u=o;u<e.length;u++)c+=e[u].length;c=Math.max(0,c-Math.floor(i));var f=t/r;f>1?c=Math.floor(c/f):(f=1,r=t),c+=s.length;var p=new Int16Array(c),d=0;for(u=0;u<s.length;u++)p[d]=s[u],d++;for(var h=e.length;o<h;o++){var v=e[o],m=(u=i,v.length);while(u<m){var g=Math.floor(u),b=Math.ceil(u),w=u-g,y=v[g],_=b<m?v[b]:(e[o+1]||[y])[0]||0;p[d]=y+(_-y)*w,d++,u+=f}i=u-m}s=null;var S=p.length%l;if(S>0){var x=2*(p.length-S);s=new Int16Array(p.buffer.slice(x)),p=new Int16Array(p.buffer.slice(0,x))}return{index:o,offset:i,frameNext:s,sampleRate:r,data:p}},a.PowerLevel=function(e,t){var r,a=e/t||0;return r=a<1251?Math.round(a/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(a/1e4)/Math.log(10))))),r},a.showLog=!1;var s=function(e,t){if(a.showLog){var r=new Date,n=("0"+r.getMinutes()).substr(-2)+":"+("0"+r.getSeconds()).substr(-2)+"."+("00"+r.getMilliseconds()).substr(-3),o=["["+n+" Recorder]"+e],i=arguments,s=2,l=console.log;for("number"==typeof t?l=1==t?console.error:3==t?console.warn:l:s=1;s<i.length;s++)o.push(i[s]);l.apply(console,o)}};a.CLog=s;var l=0;function c(e){this.id=++l;var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:r};for(var a in e)t[a]=e[a];this.set=t,this._S=9,this.Sync={O:9,C:9}}a.Sync={O:9,C:9},a.prototype=c.prototype={_streamStore:function(){return this.set.sourceStream?this:a},open:function(t,n){var l=this,c=l._streamStore();t=t||r;var u=function(e,t){t=!!t,s("录音open失败："+e+",isUserNotAllow:"+t,1),n&&n(e,t)},f=function(){s("open成功"),t(),l._SO=0},p=c.Sync,d=++p.O,h=p.C;l._O=l._O_=d,l._SO=l._S;var v=function(){if(h!=p.C||!l._O){var e="open被取消";return d==p.O?l.close():e="open被中断",u(e),!0}},m=l.envCheck({envName:"H5",canProcess:!0});if(m)u("不能录音："+m);else if(l.set.sourceStream){if(!a.Support())return void u("不支持此浏览器从流中获取录音");i(c),l.Stream=l.set.sourceStream,l.Stream._call={};try{o(c)}catch(_){return void u("从流中打开录音失败："+_.message)}f()}else{var g=function(t,r){try{e.top.a}catch(_){return void u('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(t)?u("用户拒绝了录音权限",!0):!1===e.isSecureContext?u("无权录音(需https)"):/Found/i.test(t)?u(r+"，无可用麦克风"):u(r)};if(a.IsOpen())f();else if(a.Support()){var b=function(e){a.Stream=e,e._call={},v()||setTimeout((function(){v()||(a.IsOpen()?(o(),f()):u("录音功能无效：无音频流"))}),100)},w=function(e){var t=e.name||e.message||e.code+":"+e;s("请求录音权限错误",1,e),g(t,"无法录音："+t)},y=a.Scope.getUserMedia({audio:l.set.audioTrackSet||!0},b,w);y&&y.then&&y.then(b)[t&&"catch"](w)}else g("","此浏览器不支持录音")}},close:function(e){e=e||r;var t=this,a=t._streamStore();t._stop();var n=a.Sync;if(t._O=0,t._O_!=n.O)return s("close被忽略",3),void e();n.C++,i(a),s("close"),e()},mock:function(e,t){var r=this;return r._stop(),r.isMock=1,r.mockEnvInfo=null,r.buffers=[e],r.recSize=e.length,r.srcSampleRate=t,r},envCheck:function(e){var t,r=this,a=r.set;return t||(r[a.type+"_envCheck"]?t=r[a.type+"_envCheck"](e,a):a.takeoffEncodeChunk&&(t=a.type+"类型不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var r=this,a=r.set;if(r.isMock=e?1:0,r.mockEnvInfo=e,r.buffers=[],r.recSize=0,r.envInLast=0,r.envInFirst=0,r.envInFix=0,r.envInFixTs=[],a.sampleRate=Math.min(t,a.sampleRate),r.srcSampleRate=t,r.engineCtx=0,r[a.type+"_start"]){var n=r.engineCtx=r[a.type+"_start"](a);n&&(n.pcmDatas=[],n.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var r=this,n=r.set,o=r.engineCtx,i=r.srcSampleRate,l=e.length,c=a.PowerLevel(t,l),u=r.buffers,f=u.length;u.push(e);var p=u,d=f,h=Date.now(),v=Math.round(l/i*1e3);r.envInLast=h,1==r.buffers.length&&(r.envInFirst=h-v);var m=r.envInFixTs;m.splice(0,0,{t:h,d:v});for(var g=h,b=0,w=0;w<m.length;w++){var y=m[w];if(h-y.t>3e3){m.length=w;break}g=y.t,b+=y.d}var _=m[1],S=h-g,x=S-b;if(x>S/3&&(_&&S>1e3||m.length>=6)){var M=h-_.t-v;if(M>v/5){var k=!n.disableEnvInFix;if(s("["+h+"]"+(k?"":"未")+"补偿"+M+"ms",3),r.envInFix+=M,k){var R=new Int16Array(M*i/1e3);l+=R.length,u.push(R)}}}var C=r.recSize,I=l,B=C+I;if(r.recSize=B,o){var D=a.SampleData(u,i,n.sampleRate,o.chunkInfo);o.chunkInfo=D,C=o.pcmSize,I=D.data.length,B=C+I,o.pcmSize=B,u=o.pcmDatas,f=u.length,u.push(D.data),i=D.sampleRate}var O=Math.round(B/i*1e3),T=u.length,P=p.length,L=function(){for(var e=A?0:-I,t=null==u[0],a=f;a<T;a++){var i=u[a];null==i?t=1:(e+=i.length,o&&i.length&&r[n.type+"_encode"](o,i))}if(t&&o){a=d;for(p[0]&&(a=0);a<P;a++)p[a]=null}t&&(e=A?I:0,u[0]=null),o?o.pcmSize+=e:r.recSize+=e},A=n.onProcess(u,c,O,i,f,L);if(!0===A){var E=0;for(w=f;w<T;w++)null==u[w]?E=1:u[w]=new Int16Array(0);E?s("未进入异步前不能清除buffers",3):o?o.pcmSize-=I:r.recSize-=I}else L()},start:function(){var e=this,t=a.Ctx,r=1;if(e.set.sourceStream?e.Stream||(r=0):a.IsOpen()||(r=0),r)if(s("开始录音"),e._stop(),e.state=0,e.envStart(null,t.sampleRate),e._SO&&e._SO+1!=e._S)s("start被中断",3);else{e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then((function(){s("ctx resume"),n()})):n()}else s("未open",1)},pause:function(){var e=this;e.state&&(e.state=2,s("pause"),delete e._streamStore().Stream._call[e.id])},resume:function(){var e=this;e.state&&(e.state=1,s("resume"),e.envResume(),e._streamStore().Stream._call[e.id]=function(t,r){1==e.state&&e.envIn(t,r)})},_stop:function(e){var t=this,r=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[r.type+"_stop"]&&(t[r.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(e,t,r){var n,o=this,i=o.set;s("Stop "+(o.envInLast?o.envInLast-o.envInFirst+"ms 补"+o.envInFix+"ms":"-"));var l=function(){o._stop(),r&&o.close()},c=function(e){s("结束录音失败："+e,1),t&&t(e),l()},u=function(t,r){if(s("结束录音 编码"+(Date.now()-n)+"ms 音频"+r+"ms/"+t.size+"b"),i.takeoffEncodeChunk)s("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(t.size<Math.max(100,r/2))return void c("生成的"+i.type+"无效");e&&e(t,r),l()};if(!o.isMock){if(!o.state)return void c("未开始录音");o._stop(!0)}var f=o.recSize;if(f)if(o.buffers[0])if(o[i.type]){if(o.isMock){var p=o.envCheck(o.mockEnvInfo||{envName:"mock",canProcess:!1});if(p)return void c("录音错误："+p)}var d=o.engineCtx;if(o[i.type+"_complete"]&&d){var h=Math.round(d.pcmSize/i.sampleRate*1e3);return n=Date.now(),void o[i.type+"_complete"](d,(function(e){u(e,h)}),c)}n=Date.now();var v=a.SampleData(o.buffers,o.srcSampleRate,i.sampleRate);i.sampleRate=v.sampleRate;var m=v.data;h=Math.round(m.length/i.sampleRate*1e3);s("采样"+f+"->"+m.length+" 花:"+(Date.now()-n)+"ms"),setTimeout((function(){n=Date.now(),o[i.type](m,(function(e){u(e,h)}),(function(e){c(e)}))}))}else c("未加载"+i.type+"编码器");else c("音频被释放");else c("未采集到录音")}},e.Recorder&&e.Recorder.Destroy(),e.Recorder=a,a.LM=t}))}).call(this,r("62e4")(e))},eed5:function(e,t,r){"use strict";r("2bb3")}});